/*
 Author:    Lemur
 Email:     1emvr@protonmail.com
 Date:      12/19/2022  10:33 AM

 An excerpt from the book "Hacking: The Art of Exploitation, Vol 2"

 I have not written this code myself, simply cleaned it up and made it more readable
 as the book can be very hard on the eyes.

 If my analysis is incorrect or if you have any suggestions for me I am more than happy and
 receptive to them. Please feel free to shoot me a line if you have any comments to make. <3

*/
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/stat.h>

#include "multitool.h"

void fatal(char *);
void *ec_malloc(unsigned int);
/*
    These two functions are included in the ec_malloc.h
    and are mainly used for error handling.
    Fatal() will take in an error code,
    casting it to the character-type.

    Similarly, ec_malloc() will take in a size (in bytes)
    and allocate memory while error-checking.
*/

void usage(char *program_name) {

    printf("Usage: %s <data to add> /path/to/save", program_name);
    exit(0);
/*
    Simply a message to display directions for usage when incorrect
    arguments are given. This is called on in the main() function.
*/
}

int main(int argc, char *argv[]) {
/*
    In the main() function we allocate 100 bytes to the "buffer" value
    and 20 bytes to the datafile. We then assign the file descriptor datafile name
    and permissions we need in order to create it.

    We then get our uid and copy our second cli argument as the datafile.
    Printing debug information is helpful, showing us the address location
    for our pointers and their values as well as our file descriptor.

    We start the process of error checking for agruments,
    checking if the file has been opened without issue
    and begin writing our userid and the data buffer
    to the file. Once finished, we check that the file
    closed properly and freeing the memory from buffer
    and datafile.
*/
    char *buffer = (char *) ec_malloc(512);
    char *datafile = (char *) ec_malloc(512);

    int fd = open(

        datafile,
        O_WRONLY|O_CREAT|O_APPEND,
        S_IRUSR|S_IWUSR
    );

    int userid = getuid();
    strcpy(datafile, argv[2]);

    printf("[DEBUG] buffer      @ %p: \'%s\'\n", buffer, buffer);
    printf("[DEBUG] datafile    @ %p: \'%s\'\n", datafile, datafile);
    printf("[DEBUG] file descriptor is %d\n", fd);

    if(argc != 3)
        usage(argv[0]);

    if(fd == -1)
        fatal("in main() while opening file");

    if(write(fd, &userid, 4) == -1)
        fatal("in main() while writing userid to file");
    write(fd, "\n", 1);

    if(write(fd, buffer, strlen(buffer)) == -1)
        fatal("in main() while writing buffer to file");
    write(fd, "\n", 1);

    if(close(fd) == -1)
        fatal("in main() while closing file");

    printf("Note has been saved to %s", datafile);

    free(buffer);
    free(datafile);
}
