https://papers.vx-underground.org

#### Theory

There are several encrytpion levels. Simple OR/XOR or combinations of OR/XOR/NOT etc.

Encrypted malware has the following execution structure:

	- May have a jump to the malware code (eg Maltese Amoeba) 
	or at the beginning of the file (Jerusalem)
	- Decryption Routine
	- Malware Code
	- Jump to the infected file's code

The decryption routine consists of a series of instructions that turn encrypted code into instructions. In or der to do this, several logical operations are performed on the encrypted bytes.

#### Decryption Methods

```
 Classic decryption formulas are:


    cs:0100  decrypted code
    .
    .
    .
    cs:0115  xor dl,5e
    .
    .
    .
    cs:0124  cmp ax,0
    cs:0127  je 13d
    cs:012a  jmp cs:0115
    cs:012d  encrypted code
```

1. cs:0115 is the logical operation to be performed
2. cs:0124 makes a comparison. If comparison matches, jump to 13d. If not, jump back to 115.
3. cd:013d is the beginning of the decrypted code

```
 Returning to the structures, we can find the "loop" one:


    cs:0100  decrypted code
    .
    .
    cs:0114  or al,al
    .
    .
    cs:0140  loop 114
    cs:0142  encrypted code

 In this case it would be enough to let the loop  decrypt the virus. There
 are a few variants but the base is the same:


    cs:0100  decrypted code
    .
    .
    cs:0116  stuff
    .
    .
    cs:0150  jmp to stuff
    cs:0156  decrypted code
```


There may be more problems if we're using DOS's debug when working with top-to-bottom  decryption. This is because the next instruction to the jmp will remain encrypted until the end and would be difficult to set a breakpoint after just two jumps.

We might:
```
- Use Borland's (TD) or AVP's debugger
- Be patient and do it manually
- Move the decryption routine and something more to another segment, 
get to that segment, breakpoint the instruction after the jump and then run the decrypted instruction.

To do this last step:


    -mcs:0100 400 3000:01009
    -rcs 3000
```

#### Examples

- Encrypted Maltese Amoeba virus
```
    0c39:000a  pushf
    0c39:000b  nop
    0c39:000c  nop
    0c39:000d  push  ax
    0c39:000e  push  bx
    0c39:000f  jmp   0011
    0c39:0011  xchg  cx,ax
    0c39:0012  xchg  cx,ax
    0c39:0013  mov   ah,ah
    0c39:0015  push  ds
    0c39:0016  cmc
    0c39:0017  push  es
    0c39:0018  clc
    0c39:0019  push  cs
    0c39:001a  pop   es
    0c39:001b  cld
    0c39:001c  stc
    0c39:001d  push  cs
    0c39:001e  pop   ds
    0c39:001f  mov   al,al
    0c39:0021  mov   cx,cx
    0c39:0023  sahf
    0c39:0024  cld
    0c39:0025  mov   di,004f
    0c39:0028  mov   dl,dl
    0c39:002a  mov   cx,04a6
    0c39:002d  mov   si,di
    0c39:002f  mov   ax,ax
    0c39:0031  mov   bx,bx
    0c39:0033  lodsw
    0c39:0034  xor   ax,a451
    0c39:0037  clc
    0c39:0038  jmp   003a
    0c39:003a  stosw
    0c39:003b  loop  0033
               ^^^^
```

Here we have the famous jump that returns to the above addresses.

```
    0c39:003d  cli
    0c39:003e  pop   ax
    0c39:003f  xchg  cx,ax
    0c39:0040  xchg  cx,ax
    0c39:0041  mov   ah,ah
    0c39:0043  add   [01c3],ax
    0c39:0047  cld
    0c39:0048  mov   al,al
    0c39:004a  add   [0086],ax
    0c39:004e  nop
    0c39:004f  stosw
    0c39:0050  db    69
    0c39:0051  dec   bp
    0c39:0052  das
    0c39:0053  mov   bp,172f
    0c39:0056  pop   ax
    0c39:0057  fistp qword ptr [si-26]
    0c39:005a  repnz
    0c39:005b  stosw
    0c39:005C  imul  cl
    0c39:005E  mov   dl,7a
    0c39:0060  sbb   ax,a212
    0c39:0063  pushf
    0c39:0064  test  bp,[si-59]
    0c39:0067  inc   di
```

And once decrypted:

```
    [...]
    0c39:0034  xor   ax,a451
    0c39:0037  clc
    0c39:0038  jmp   003a
    0c39:003a  stosw
    0c39:003b  loop  0033
    0c39:003d  cli
    0c39:003e  pop   ax
    0c39:003f  xchg  cx,ax
    0c39:0040  xchg  cx,ax
    0c39:0041  mov   ah,ah
    0c39:0043  add   [01c3],ax
    0c39:0047  cld
    0c39:0048  mov   al,al
    0c39:004a  add   [0086],ax
    0c39:004e  nop
    0c39:004f  cli
    0c39:0050  int   1c
    0c39:0052  mov   bp,sp
    0c39:0054  mov   ax,[bp-04]
    0c39:0057  mov   ds,ax
    0c39:0059  mov   dx,[bp-06]
    0c39:005c  push  dx
```



