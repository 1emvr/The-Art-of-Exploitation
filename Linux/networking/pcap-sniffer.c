#include <pcap.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#include "multitool.h"

void pcap_fatal(const char *failed_in, const char *errbuff) {
    printf("[!!] Fatal Error in %s: %s\n", failed_in, errbuff);
    exit(1);
}

int main() {

    struct pcap_pkthdr header;
    char errbuff[PCAP_ERRBUF_SIZE];
    char *device;

    pcap_t *pcap_handle;
    const unsigned char *packet;

    device = pcap_lookupdev(errbuff);

    if(device == NULL)
        pcap_fatal("pcap_lookupdev", errbuff);
    printf("Got a %d byte packet\n", header.len);

    pcap_handle = pcap_open_live(device, 4096, 1, 0, errbuff);

    if(pcap_handle == NULL)
        pcap_fatal("pcap_open_live", errbuff);
    
    for( int i=0; i<3; i++ ) {
        packet = pcap_next(pcap_handle, &header);
        printf("Got a %d byte packet\n", header.len);
        hexdump(packet, header.len);
    }
    pcap_close(pcap_handle);
}